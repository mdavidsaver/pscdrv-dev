
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>PSC TCP Protocol &#8212; pscdrv  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Building from Source" href="building.html" />
    <link rel="prev" title="The PSC Driver" href="index.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="building.html" title="Building from Source"
             accesskey="N">next</a> |</li>
        <li class="right" >
          <a href="index.html" title="The PSC Driver"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pscdrv  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="psc-tcp-protocol">
<h1>PSC TCP Protocol<a class="headerlink" href="#psc-tcp-protocol" title="Permalink to this headline">¶</a></h1>
<p>The PSC transport protocol uses TCP to transport a bi-direction stream of messages
between a device and an IOC.
Each message consists of a fixed length 8 byte header followed by a variable length body.</p>
<img alt="_images/message-stream.svg" src="_images/message-stream.svg" /><p>The header has 3 fields: framing marker (2 bytes), message ID (2 bytes), and body length (4 bytes).
The framing marker is ASCII charactors ‘P’ and ‘S’.
The other two are unsigned integers in big endian byte order.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>
   <span class="o">+-----+-----+-----------+</span>
<span class="mi">0</span>  <span class="o">|</span>  <span class="n">P</span>  <span class="o">|</span>  <span class="n">S</span>  <span class="o">|</span>   <span class="n">Msg</span> <span class="n">ID</span>  <span class="o">|</span>
   <span class="o">+-----+-----+-----------+</span>
<span class="mi">4</span>  <span class="o">|</span>      <span class="n">Body</span> <span class="n">Length</span>      <span class="o">|</span>
   <span class="o">+-----------------------+</span>
<span class="mi">8</span>  <span class="o">|</span>      <span class="n">Body</span> <span class="nb">bytes</span> <span class="o">...</span>   <span class="o">|</span>
</pre></div>
</div>
<p>An equivalent C structure definition for a message header would be:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">struct</span> <span class="n">pscHeader</span> <span class="p">{</span>
  <span class="n">char</span> <span class="n">P</span><span class="p">;</span> <span class="o">/*</span> <span class="n">must</span> <span class="n">be</span> <span class="s1">&#39;P&#39;</span> <span class="o">*/</span>
  <span class="n">char</span> <span class="n">S</span><span class="p">;</span> <span class="o">/*</span> <span class="n">must</span> <span class="n">be</span> <span class="s1">&#39;S&#39;</span> <span class="o">*/</span>
  <span class="n">uint16_t</span> <span class="n">msgid</span><span class="p">;</span>
  <span class="n">uint32_t</span> <span class="n">bodylen</span><span class="p">;</span> <span class="o">/*</span> <span class="ow">in</span> <span class="nb">bytes</span> <span class="o">*/</span>
<span class="p">};</span>
<span class="k">assert</span><span class="p">(</span><span class="n">sizeof</span><span class="p">(</span><span class="n">struct</span> <span class="n">pscdrvHeader</span><span class="p">)</span><span class="o">==</span><span class="mi">8</span><span class="p">);</span>
</pre></div>
</div>
<div class="section" id="single-register-sub-protocol">
<h2>Single Register Sub-protocol<a class="headerlink" href="#single-register-sub-protocol" title="Permalink to this headline">¶</a></h2>
<p>The Single Register Write Device Supports understand a sub-header containing a 32-bit unsigned
integer address and 0 or more bytes of value.  Thus the minimum body length allowed is 4 bytes.</p>
<p>This is included to support the common case of writing individually
addressable registers without exhausting the available message IDs.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>      <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>
   <span class="o">+-----+-----+-----------+</span>
<span class="mi">0</span>  <span class="o">|</span>  <span class="n">P</span>  <span class="o">|</span>  <span class="n">S</span>  <span class="o">|</span>   <span class="n">Msg</span> <span class="n">ID</span>  <span class="o">|</span>
   <span class="o">+-----+-----+-----+-----+</span>
<span class="mi">4</span>  <span class="o">|</span>      <span class="n">Body</span> <span class="n">Length</span>      <span class="o">|</span>
   <span class="o">+-----+-----+-----+-----+</span>
<span class="mi">8</span>  <span class="o">|</span>         <span class="n">Address</span>       <span class="o">|</span>
   <span class="o">+-----+-----+-----------+</span>
<span class="n">C</span>  <span class="o">|</span>         <span class="n">Value</span>         <span class="o">|</span>
   <span class="o">+-----------------------+</span>
<span class="n">F</span>  <span class="o">|</span>         <span class="n">Value</span> <span class="o">...</span>     <span class="o">|</span>
</pre></div>
</div>
</div>
<div class="section" id="protocol-usage-and-device-design">
<h2>Protocol Usage and Device Design<a class="headerlink" href="#protocol-usage-and-device-design" title="Permalink to this headline">¶</a></h2>
<p>In the PSC driver, the message ID is used to determine how the message body is interpreted.
For example message ID 1 might be used by a device to send/recv a fixed length array of register values,
while ID 20 is used to send a variable length array of ADC values.</p>
<p>It is not necessary for a given message ID to have the same meaning when received by the Device,
as when received by the IOC.  However, this is recommended to preserve engineer sanity.</p>
<p>By design this protocol does not require that messages are acknowledged, or replied to, but the recipient.
The TCP transport protocol already provides some guarantees of message delivery.
It is intended that send/receive synchronization can be achieved by, for example,
ensuring that when a device register is changed, that a message with the updated value will be sent to the IOC (or IOCs)
automatically.</p>
<p>Explicit request/response can to some extent be implemented with Records.</p>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">PSC TCP Protocol</a><ul>
<li><a class="reference internal" href="#single-register-sub-protocol">Single Register Sub-protocol</a></li>
<li><a class="reference internal" href="#protocol-usage-and-device-design">Protocol Usage and Device Design</a></li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="index.html"
                        title="previous chapter">The PSC Driver</a></p>
  <h4>Next topic</h4>
  <p class="topless"><a href="building.html"
                        title="next chapter">Building from Source</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/protocol.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="building.html" title="Building from Source"
             >next</a> |</li>
        <li class="right" >
          <a href="index.html" title="The PSC Driver"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pscdrv  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Michael Davidsaver.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>