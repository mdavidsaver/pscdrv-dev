
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>UDP “Fast” Receiver &#8212; pscdrv  documentation</title>
    <link rel="stylesheet" href="_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="_static/language_data.js"></script>
    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="prev" title="Device Supports" href="devsup.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="right" >
          <a href="devsup.html" title="Device Supports"
             accesskey="P">previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pscdrv  documentation</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <div class="section" id="udp-fast-receiver">
<h1>UDP “Fast” Receiver<a class="headerlink" href="#udp-fast-receiver" title="Permalink to this headline">¶</a></h1>
<p><code class="docutils literal notranslate"><span class="pre">udpApp/</span></code> contains a specialized equivalent PSC driver variant intended
for capturing and (optionally) recording to disk PSC UDP traffic from high bandwidth devices.
This was originally developed to continuously consume and record 1.8 Gbps (234 MB/s) of traffic.
This variant uses Linux specific APIs (eg. <code class="docutils literal notranslate"><span class="pre">recvmmsg()</span></code> and <code class="docutils literal notranslate"><span class="pre">writev()</span></code>)
to reduce overheads.</p>
<p>UDP “fast” instances support all the usual <a class="reference internal" href="devsup.html#devsup"><span class="std std-ref">Device Supports</span></a> as well as those listed below.</p>
<p>See <code class="docutils literal notranslate"><span class="pre">iocBoot/iocudpfast/st.cmd</span></code> for an example usage.</p>
<div class="section" id="usage">
<h2>Usage<a class="headerlink" href="#usage" title="Permalink to this headline">¶</a></h2>
<p>A driver instance needs to be created with <code class="docutils literal notranslate"><span class="pre">createPSCUDPFast()</span></code></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># listen on 0.0.0.0:8765</span>
<span class="c1"># for packets from 1.2.3.4:5678</span>
<span class="n">createPSCUDPFast</span><span class="p">(</span><span class="s2">&quot;test&quot;</span><span class="p">,</span> <span class="s2">&quot;1.2.3.4&quot;</span><span class="p">,</span> <span class="mi">5678</span><span class="p">,</span> <span class="mi">8765</span><span class="p">)</span>
</pre></div>
</div>
<div class="section" id="control-status-db">
<h3>Control/Status DB<a class="headerlink" href="#control-status-db" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">pscudpfast.db</span></code> database provides control/status of the file writing process,
as well as monitoring of network and file I/O performance.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">dbLoadRecords</span><span class="p">(</span><span class="s2">&quot;db/pscudpfast.db&quot;</span><span class="p">,</span> <span class="s2">&quot;NAME=test,P=TST:&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="tunable-parameters">
<h3>Tunable Parameters<a class="headerlink" href="#tunable-parameters" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPMaxPacketSize</span></code> (default 1024) Size in bytes of packet buffers.  Larger packets will be ignored.</li>
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPMaxPacketRate</span></code> (default 280000) Estimated maximum packet rate in packets per second.  Used to size pool of pre-allocated packet buffer pool.</li>
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPBufferPeriod</span></code> (default 1.0) Estimated time in seconds to buffer packets.  Used to size pool of pre-allocated packet buffer pool.</li>
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPMaxLenMB</span></code> (default 2000) File size at which to rotate to a new/empty file.</li>
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPSetSockBuf</span></code> (default 0)  If non-zero, attempt to set resize OS socket buffer.</li>
<li><code class="docutils literal notranslate"><span class="pre">PSCUDPDSyncSizeMB</span></code> (default 0)  If non-zero, <cite>flush()</cite> data files writing this many MBs of data.</li>
</ul>
</div>
<div class="section" id="add-to-ioc">
<h3>Add to IOC<a class="headerlink" href="#add-to-ioc" title="Permalink to this headline">¶</a></h3>
<p>The “fast” receiver is included in a separate DBD and library.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">myioc_DBD</span> <span class="o">+=</span> <span class="n">pscUDPFast</span><span class="o">.</span><span class="n">dbd</span>
<span class="n">myioc_LIBS</span> <span class="o">+=</span> <span class="n">pscUDPFast</span>
</pre></div>
</div>
<p>See also <a class="reference internal" href="building.html#includinginioc"><span class="std std-ref">Including pscdrv in your IOC</span></a>.</p>
</div>
<div class="section" id="troubleshooting">
<h3>Troubleshooting<a class="headerlink" href="#troubleshooting" title="Permalink to this headline">¶</a></h3>
<p>The diagnostic rates/counters in <code class="docutils literal notranslate"><span class="pre">pscudpfast.db</span></code> should be consulted first.
Either the packet RX rate (<code class="docutils literal notranslate"><span class="pre">$(P)RXRate-I</span></code>) or the timeout rate (<code class="docutils literal notranslate"><span class="pre">$(P)TmoRate-I</span></code>) should be non-zero.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">PSCDebug</span></code> global log level may be changed.
The default (0) will only print errors.
This can be raised up to 5 to print additional warnings and status.
Note that levels 3 and above are quite verbose.</p>
</div>
</div>
<div class="section" id="admin-setup">
<h2>Admin setup<a class="headerlink" href="#admin-setup" title="Permalink to this headline">¶</a></h2>
<p>It is expected that a larger socket buffer size will be needed to avoid sporadic packet loss.
This may be accomplished by raising the limit of socket buffer size.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sysctl net.core.rmem_max=3407872
</pre></div>
</div>
<p>And then setting <cite>PSCUDPSetSockBuf</cite> accordingly.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">PSCUDPSetSockBuf</span> <span class="mi">3407872</span>
</pre></div>
</div>
<p>This may be made persistent with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysctl</span><span class="o">.</span><span class="n">d</span><span class="o">/</span><span class="mi">99</span><span class="o">-</span><span class="n">pscdrv</span><span class="o">.</span><span class="n">conf</span>
<span class="c1"># raise limit on socket RX buffer</span>
<span class="n">net</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">rmem_max</span><span class="o">=</span><span class="mi">3407872</span>
<span class="n">EOF</span>
</pre></div>
</div>
<p>It may also be desirable to run IOCs with realtime priorities.
To avoid a certain type of priority inversion, if this is done,
it is recommended to ensure that the priorities of Linux OS
interrupt handling thread have a higher priority than IOC threads.
A quick way to do this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># for pid in `pgrep &#39;^irq/&#39;`; do readlink /proc/$pid/exe || chrt -f -p 92 $pid; done</span>
</pre></div>
</div>
<p>One way to make this persistent is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cat</span> <span class="o">&lt;&lt;</span><span class="n">EOF</span> <span class="o">&gt;</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">systemd</span><span class="o">/</span><span class="n">system</span><span class="o">/</span><span class="n">irq</span><span class="o">-</span><span class="n">prio</span><span class="o">.</span><span class="n">service</span>
<span class="p">[</span><span class="n">Unit</span><span class="p">]</span>
<span class="n">Description</span><span class="o">=</span><span class="n">Raise</span> <span class="n">IRQ</span> <span class="n">thread</span> <span class="n">priority</span>
<span class="p">[</span><span class="n">Service</span><span class="p">]</span>
<span class="n">Type</span><span class="o">=</span><span class="n">oneshot</span>
<span class="n">ExecStart</span><span class="o">=/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span> <span class="o">-</span><span class="n">c</span> <span class="s1">&#39;for pid in `pgrep &quot;^irq/&quot;`; do readlink /proc/\$pid/exe || chrt -f -p 92 \$pid; done&#39;</span>
<span class="n">RemainAfterExit</span><span class="o">=</span><span class="n">yes</span>
<span class="p">[</span><span class="n">Install</span><span class="p">]</span>
<span class="n">WantedBy</span><span class="o">=</span><span class="n">multi</span><span class="o">-</span><span class="n">user</span><span class="o">.</span><span class="n">target</span>
<span class="n">EOF</span>
<span class="n">systemctl</span> <span class="n">daemon</span><span class="o">-</span><span class="n">reload</span>
<span class="n">systemctl</span> <span class="n">start</span> <span class="n">irq</span><span class="o">-</span><span class="n">prio</span><span class="o">.</span><span class="n">service</span>
<span class="n">systemctl</span> <span class="n">enable</span> <span class="n">irq</span><span class="o">-</span><span class="n">prio</span><span class="o">.</span><span class="n">service</span>
</pre></div>
</div>
<p>One way to grant the IOC executable permission to set RT priorities without also granting
full superuser privilege is to add file capabilities.  eg.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setcap</span> <span class="n">cap_ipc_lock</span><span class="p">,</span><span class="n">cap_sys_nice</span><span class="o">+</span><span class="n">ep</span> <span class="nb">bin</span><span class="o">/</span><span class="n">linux</span><span class="o">-</span><span class="n">x86_64</span><span class="o">/</span><span class="n">pscdemo</span>
</pre></div>
</div>
<p>Note that Linux file capabilities are ignored if a filesystem is mounted with the <code class="docutils literal notranslate"><span class="pre">nosuid</span></code> option.</p>
</div>
<div class="section" id="file-writing">
<h2>File Writing<a class="headerlink" href="#file-writing" title="Permalink to this headline">¶</a></h2>
<div class="section" id="file-name-selection">
<h3>File name selection<a class="headerlink" href="#file-name-selection" title="Permalink to this headline">¶</a></h3>
<p>Data file names are formed by concatenating the string PVs <code class="docutils literal notranslate"><span class="pre">$(P)FileDir-SP</span></code> and <code class="docutils literal notranslate"><span class="pre">$(P)FileBase-SP</span></code>
with a slash in between, then appending the current date and time in UTC as “YYYYMMDD-HHMMSS.dat”.
So if FileDir is “/data” and FileBase is “run1-“, then an output filename might be:
“/data/run1-20210401-034500.dat”.
The most recent data filename is indicated by <code class="docutils literal notranslate"><span class="pre">$(P)LastFile-I</span></code>.</p>
</div>
<div class="section" id="file-format">
<h3>File Format<a class="headerlink" href="#file-format" title="Permalink to this headline">¶</a></h3>
<p>The .dat file written have a binary format similar to the wire protocol.
With an additional reception timestamp included.
Each file will contain a sequence of such “packets” concatenated together.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>       <span class="mi">0</span>     <span class="mi">1</span>     <span class="mi">2</span>     <span class="mi">3</span>
    <span class="o">+-----+-----+-----------+</span>
 <span class="mi">0</span>  <span class="o">|</span>  <span class="n">P</span>  <span class="o">|</span>  <span class="n">S</span>  <span class="o">|</span>   <span class="n">Msg</span> <span class="n">ID</span>  <span class="o">|</span>
    <span class="o">+-----+-----+-----------+</span>
 <span class="mi">4</span>  <span class="o">|</span>      <span class="n">Body</span> <span class="n">Length</span>      <span class="o">|</span>
    <span class="o">+-----------------------+</span>
 <span class="n">C</span>  <span class="o">|</span>      <span class="n">Seconds</span>          <span class="o">|</span>
    <span class="o">+-----------------------+</span>
<span class="mi">10</span>  <span class="o">|</span>      <span class="n">Nano</span><span class="o">-</span><span class="n">seconds</span>     <span class="o">|</span>
    <span class="o">+-----------------------+</span>
<span class="mi">14</span>  <span class="o">|</span>      <span class="n">Body</span> <span class="nb">bytes</span> <span class="o">...</span>   <span class="o">|</span>
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">Seconds</span></code> field is an integer number of seconds since the POSIX epoch (1 Jan 1970 UTC).</p>
</div>
</div>
<div class="section" id="operation">
<h2>Operation<a class="headerlink" href="#operation" title="Permalink to this headline">¶</a></h2>
<p>The <code class="docutils literal notranslate"><span class="pre">PSCUDPFast</span></code> class uses a multistage buffer based on a fixed size pool of pre-allocated packet buffers.
Statistics are kept of the percentage of total buffers in three states: unallocated (<code class="docutils literal notranslate"><span class="pre">$(P)PFree-I</span></code>),
filled with packet data (<code class="docutils literal notranslate"><span class="pre">$(P)PRXe-I</span></code>), and being written to disk (<code class="docutils literal notranslate"><span class="pre">$(P)PWrt-I</span></code>).
During normal/stable operation, most buffers should be unallocated.
Buffering is designed to smooth over occasional slowdowns in disk I/O of up to <cite>PSCUDPBufferPeriod</cite> seconds.</p>
<p>If no unallocated/free packet buffers are available, then the driver will stop calling <code class="docutils literal notranslate"><span class="pre">recvmmsg()</span></code>
and wait for buffers to become available.
eg. when some <cite>writev()</cite> has completed.
If this takes too long, the socket RX buffer will overflow.
Overflows should be indicated by a non-zero value of <code class="docutils literal notranslate"><span class="pre">$(P)DrpRate-I</span></code> after the next <code class="docutils literal notranslate"><span class="pre">recvmmsg()</span></code>.</p>
<img alt="_images/buffering.svg" src="_images/buffering.svg" /><p>The Message Cache holds the most recently received packet for each message ID,
and is accessible through the <a class="reference internal" href="devsup.html#devsupreg"><span class="std std-ref">Register Block Access</span></a> and <a class="reference internal" href="devsup.html#devsupblock"><span class="std std-ref">Waveform Block Access</span></a> device supports.</p>
<p>The “short” buffer is intended to hold a few consecutive packets to facilitate online status and verification.
The buffer depth is control by the largest <code class="docutils literal notranslate"><span class="pre">NELM</span></code> of an associated aaiRecord.</p>
<div class="section" id="short-device-support">
<h3>“Short” Device Support<a class="headerlink" href="#short-device-support" title="Permalink to this headline">¶</a></h3>
<p>“Short” buffer device support is meant to be a single chain (per device)
beginning with a periodic scan, and ending with the “Clear” device support.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">record</span><span class="p">(</span><span class="n">aai</span><span class="p">,</span> <span class="s2">&quot;$(P)val0&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DTYP</span><span class="p">,</span> <span class="s2">&quot;PSCUDPFast Get Short&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">INP</span> <span class="p">,</span> <span class="s2">&quot;@test 12345 0&quot;</span><span class="p">)</span> <span class="c1"># message id 12345, offset 0 bytes</span>
    <span class="n">field</span><span class="p">(</span><span class="n">SCAN</span><span class="p">,</span> <span class="s2">&quot;1 second&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">FTVL</span><span class="p">,</span> <span class="s2">&quot;ULONG&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">NELM</span><span class="p">,</span> <span class="s2">&quot;16&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">FLNK</span><span class="p">,</span> <span class="s2">&quot;$(P)val1&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">record</span><span class="p">(</span><span class="n">aai</span><span class="p">,</span> <span class="s2">&quot;$(P)val1&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DTYP</span><span class="p">,</span> <span class="s2">&quot;PSCUDPFast Get Short&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">INP</span> <span class="p">,</span> <span class="s2">&quot;@test 12345 1&quot;</span><span class="p">)</span> <span class="c1"># message id 12345, offset 4 bytes</span>
    <span class="n">field</span><span class="p">(</span><span class="n">SCAN</span><span class="p">,</span> <span class="s2">&quot;1 second&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">FTVL</span><span class="p">,</span> <span class="s2">&quot;ULONG&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">NELM</span><span class="p">,</span> <span class="s2">&quot;16&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">FLNK</span><span class="p">,</span> <span class="s2">&quot;$(P)clr&quot;</span><span class="p">)</span>
<span class="p">}</span>

<span class="n">record</span><span class="p">(</span><span class="n">longin</span><span class="p">,</span> <span class="s2">&quot;$(P)clr&quot;</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">field</span><span class="p">(</span><span class="n">DTYP</span><span class="p">,</span> <span class="s2">&quot;PSCUDPFast Clear Short&quot;</span><span class="p">)</span>
    <span class="n">field</span><span class="p">(</span><span class="n">INP</span> <span class="p">,</span> <span class="s2">&quot;@test&quot;</span><span class="p">)</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>


          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
  <h3><a href="index.html">Table of Contents</a></h3>
  <ul>
<li><a class="reference internal" href="#">UDP “Fast” Receiver</a><ul>
<li><a class="reference internal" href="#usage">Usage</a><ul>
<li><a class="reference internal" href="#control-status-db">Control/Status DB</a></li>
<li><a class="reference internal" href="#tunable-parameters">Tunable Parameters</a></li>
<li><a class="reference internal" href="#add-to-ioc">Add to IOC</a></li>
<li><a class="reference internal" href="#troubleshooting">Troubleshooting</a></li>
</ul>
</li>
<li><a class="reference internal" href="#admin-setup">Admin setup</a></li>
<li><a class="reference internal" href="#file-writing">File Writing</a><ul>
<li><a class="reference internal" href="#file-name-selection">File name selection</a></li>
<li><a class="reference internal" href="#file-format">File Format</a></li>
</ul>
</li>
<li><a class="reference internal" href="#operation">Operation</a><ul>
<li><a class="reference internal" href="#short-device-support">“Short” Device Support</a></li>
</ul>
</li>
</ul>
</li>
</ul>

  <h4>Previous topic</h4>
  <p class="topless"><a href="devsup.html"
                        title="previous chapter">Device Supports</a></p>
  <div role="note" aria-label="source link">
    <h3>This Page</h3>
    <ul class="this-page-menu">
      <li><a href="_sources/udpfast.rst.txt"
            rel="nofollow">Show Source</a></li>
    </ul>
   </div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    </div>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="genindex.html" title="General Index"
             >index</a></li>
        <li class="right" >
          <a href="devsup.html" title="Device Supports"
             >previous</a> |</li>
        <li class="nav-item nav-item-0"><a href="index.html">pscdrv  documentation</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2021, Michael Davidsaver.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 1.8.4.
    </div>
  </body>
</html>